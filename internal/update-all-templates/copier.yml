_min_copier_version: "9.0"
_subdirectory: .

# Internal maintainer utility: update ALL listed template directories with current common assets.

templates_list:
  type: str
  default: "gha gist prompteng sst typescript"
  help: Space-separated list of template directory names under templates/ to refresh

confirm_all:
  type: bool
  default: false
  help: MUST be true to proceed (safety guard)


overwrite_mode:
  type: str
  choices:
    - overwrite
    - skip
  default: overwrite
  help: Overwrite existing files or skip them

_message_after_copy: |
  {% if confirm_all %}
  Updated templates (all common assets): {{ templates_list }}
  {% else %}
  Skipped update because confirm_all was false.
  {% endif %}

_tasks:
  - >-
    bash -c '
    set -euo pipefail;
    {% if not confirm_all %} echo "confirm_all=false; aborting." >&2; exit 0; {% endif %}
    RSYNC_BASE=(rsync -a --exclude README.md);
    {% if overwrite_mode == 'skip' %} RSYNC_BASE+=(--ignore-existing); {% endif %}
    for T in {{ templates_list }}; do
      if [ ! -d templates/$T ]; then echo "[warn] templates/$T missing, skipping" >&2; continue; fi;
      echo "-- Updating $T" >&2;
      # Always copy ALL common artifacts
      mkdir -p templates/$T/.github/chatmodes;
      mkdir -p templates/$T/.github/instructions;
      mkdir -p templates/$T/.github/prompts;
      mkdir -p templates/$T/.vscode/mcp;
      "${RSYNC_BASE[@]}" common/.github/chatmodes/ templates/$T/.github/chatmodes/;
      "${RSYNC_BASE[@]}" common/.github/instructions/ templates/$T/.github/instructions/;
      "${RSYNC_BASE[@]}" common/.github/prompts/ templates/$T/.github/prompts/;
      "${RSYNC_BASE[@]}" common/.vscode/mcp/ templates/$T/.vscode/mcp/;
      for f in mcp.json settings.json; do
        if [ -f common/.vscode/$f ]; then
          mkdir -p templates/$T/.vscode;
          cp -f common/.vscode/$f templates/$T/.vscode/
        fi
      done;
    done;
    echo "All done."'
